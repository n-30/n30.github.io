<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CSV Upload with Filter & Export</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <script>
        // Wait for libraries to load
        window.addEventListener('load', function() {
            console.log('jsPDF available:', typeof window.jspdf !== 'undefined');
        });
    </script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 20px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .btn {
            background: #007bff;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            margin: 5px;
        }
        .btn:hover { background: #0056b3; }
        .btn-success { background: #28a745; }
        .btn-success:hover { background: #218838; }
        .file-info {
            margin: 20px 0;
            padding: 15px;
            background: #e9ecef;
            border-radius: 5px;
        }
        .filters {
            margin: 20px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 5px;
            display: none;
        }
        .column-selector {
            margin: 15px 0;
            padding: 15px;
            background: #fff3cd;
            border-radius: 5px;
        }
        .column-checkboxes {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin: 10px 0;
        }
        .column-checkboxes label {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 12px;
        }
        .filter-row {
            display: flex;
            gap: 10px;
            margin: 10px 0;
            align-items: center;
        }
        .filter-row select, .filter-row input {
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 3px;
        }
        .preview {
            margin-top: 20px;
            max-height: 400px;
            overflow: auto;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }
        th, td {
            padding: 8px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        th {
            background: #f8f9fa;
            font-weight: bold;
            position: sticky;
            top: 0;
        }
        .error {
            color: #dc3545;
            background: #f8d7da;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .success {
            color: #155724;
            background: #d4edda;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .stats {
            margin: 10px 0;
            padding: 10px;
            background: #e3f2fd;
            border-radius: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>CSV Upload with Filter & Export</h1>
        
        <input type="file" id="csvFileInput" accept=".csv" style="display: none;">
        <button class="btn" onclick="document.getElementById('csvFileInput').click()">
            üìÅ Choose CSV File
        </button>
        
        <div id="fileInfo" class="file-info" style="display: none;"></div>
        <div id="message"></div>
        
        <div id="filters" class="filters">
            <div class="column-selector">
                <h4>Select Columns to Display</h4>
                <div id="columnCheckboxes" class="column-checkboxes"></div>
                <button class="btn" onclick="selectAllColumns()">Select All</button>
                <button class="btn" onclick="deselectAllColumns()">Deselect All</button>
            </div>
            <h3>Row Filters</h3>
            <div id="filterControls"></div>
            <button class="btn" onclick="applyFilters()">Apply Filters</button>
            <button class="btn" onclick="clearFilters()">Clear Filters</button>
        </div>
        
        <div id="stats" class="stats" style="display: none;"></div>
        
        <div style="margin: 20px 0;">
            <button class="btn btn-success" onclick="exportToPDF()" style="display: none;" id="exportBtn">
                üìÑ Export to PDF
            </button>
        </div>
        
        <div id="preview" class="preview" style="display: none;"></div>
    </div>

    <script>
        let allData = [];
        let filteredData = [];
        let headers = [];
        let selectedColumns = [];
        
        document.getElementById('csvFileInput').addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            document.getElementById('fileInfo').innerHTML = `
                <strong>File:</strong> ${file.name} (${(file.size / 1024).toFixed(2)} KB)
            `;
            document.getElementById('fileInfo').style.display = 'block';
            
            if (!file.name.toLowerCase().endsWith('.csv')) {
                showMessage('Error: Please select a CSV file.', 'error');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                parseCSV(e.target.result);
            };
            reader.readAsText(file);
        });
        
        function parseCSV(csv) {
            try {
                const lines = csv.split('\n').filter(line => line.trim());
                headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
                
                allData = [];
                for (let i = 1; i < lines.length; i++) {
                    const row = lines[i].split(',').map(cell => cell.trim().replace(/"/g, ''));
                    if (row.length === headers.length) {
                        allData.push(row);
                    }
                }
                
                filteredData = [...allData];
                showMessage(`Success: Loaded ${allData.length} rows with ${headers.length} columns.`, 'success');
                
                setupFilters();
                displayData();
                document.getElementById('exportBtn').style.display = 'inline-block';
                
            } catch (error) {
                showMessage(`Error parsing CSV: ${error.message}`, 'error');
            }
        }
        
        function setupFilters() {
            // Setup column selector
            const columnCheckboxes = document.getElementById('columnCheckboxes');
            columnCheckboxes.innerHTML = '';
            selectedColumns = [...Array(headers.length).keys()]; // All columns selected by default
            
            headers.forEach((header, index) => {
                const label = document.createElement('label');
                label.innerHTML = `
                    <input type="checkbox" id="col_${index}" checked onchange="updateSelectedColumns()">
                    ${header}
                `;
                columnCheckboxes.appendChild(label);
            });
            
            // Setup row filters
            const filterControls = document.getElementById('filterControls');
            filterControls.innerHTML = '';
            
            headers.forEach((header, index) => {
                const uniqueValues = [...new Set(allData.map(row => row[index]))].sort().slice(0, 50);
                
                const filterRow = document.createElement('div');
                filterRow.className = 'filter-row';
                filterRow.innerHTML = `
                    <label style="min-width: 100px;">${header}:</label>
                    <select id="filter_${index}">
                        <option value="">All</option>
                        ${uniqueValues.map(val => `<option value="${val}">${val}</option>`).join('')}
                    </select>
                    <input type="text" id="search_${index}" placeholder="Search..." style="width: 150px;">
                `;
                filterControls.appendChild(filterRow);
            });
            
            document.getElementById('filters').style.display = 'block';
        }
        
        function updateSelectedColumns() {
            selectedColumns = [];
            headers.forEach((_, index) => {
                if (document.getElementById(`col_${index}`).checked) {
                    selectedColumns.push(index);
                }
            });
            displayData();
        }
        
        function selectAllColumns() {
            headers.forEach((_, index) => {
                document.getElementById(`col_${index}`).checked = true;
            });
            updateSelectedColumns();
        }
        
        function deselectAllColumns() {
            headers.forEach((_, index) => {
                document.getElementById(`col_${index}`).checked = false;
            });
            selectedColumns = [];
            displayData();
        }
        
        function applyFilters() {
            filteredData = allData.filter(row => {
                return headers.every((header, index) => {
                    const selectFilter = document.getElementById(`filter_${index}`).value;
                    const searchFilter = document.getElementById(`search_${index}`).value.toLowerCase();
                    
                    if (selectFilter && row[index] !== selectFilter) return false;
                    if (searchFilter && !row[index].toLowerCase().includes(searchFilter)) return false;
                    
                    return true;
                });
            });
            
            displayData();
        }
        
        function clearFilters() {
            headers.forEach((_, index) => {
                document.getElementById(`filter_${index}`).value = '';
                document.getElementById(`search_${index}`).value = '';
            });
            filteredData = [...allData];
            displayData();
        }
        
        function displayData() {
            const preview = document.getElementById('preview');
            const stats = document.getElementById('stats');
            
            if (selectedColumns.length === 0) {
                preview.innerHTML = '<p style="padding: 20px; text-align: center; color: #666;">Please select at least one column to display.</p>';
                preview.style.display = 'block';
                return;
            }
            
            stats.innerHTML = `
                <strong>Stats:</strong> Showing ${filteredData.length} of ${allData.length} rows, ${selectedColumns.length} of ${headers.length} columns
            `;
            stats.style.display = 'block';
            
            const selectedHeaders = selectedColumns.map(i => headers[i]);
            
            let html = '<table>';
            html += '<tr>' + selectedHeaders.map(h => `<th>${h}</th>`).join('') + '</tr>';
            
            filteredData.slice(0, 100).forEach(row => {
                const selectedCells = selectedColumns.map(i => row[i] || '');
                html += '<tr>' + selectedCells.map(cell => `<td>${cell}</td>`).join('') + '</tr>';
            });
            
            html += '</table>';
            
            if (filteredData.length > 100) {
                html += '<p style="padding: 10px; text-align: center; color: #666;">Showing first 100 rows. Export to PDF for complete data.</p>';
            }
            
            preview.innerHTML = html;
            preview.style.display = 'block';
        }
        
        function exportToPDF() {
            console.log('Export PDF clicked');
            
            try {
                if (typeof window.jspdf === 'undefined') {
                    console.error('jsPDF not loaded');
                    showMessage('PDF library not loaded. Please refresh and try again.', 'error');
                    return;
                }
                
                if (selectedColumns.length === 0) {
                    showMessage('Please select at least one column to export.', 'error');
                    return;
                }
                
                console.log('Creating PDF...');
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                const selectedHeaders = selectedColumns.map(i => headers[i]);
                const selectedData = filteredData.map(row => selectedColumns.map(i => row[i] || ''));
                
                console.log('Headers:', selectedHeaders);
                console.log('Data rows:', selectedData.length);
                
                doc.setFontSize(16);
                doc.text('CSV Export', 20, 20);
                
                doc.setFontSize(10);
                doc.text(`Rows: ${selectedData.length}, Columns: ${selectedHeaders.length}`, 20, 30);
                doc.text(`Date: ${new Date().toLocaleDateString()}`, 20, 35);
                
                if (typeof doc.autoTable === 'function') {
                    doc.autoTable({
                        head: [selectedHeaders],
                        body: selectedData,
                        startY: 45,
                        styles: { fontSize: 8, cellPadding: 2 },
                        headStyles: { fillColor: [41, 128, 185], textColor: 255 },
                        alternateRowStyles: { fillColor: [245, 245, 245] },
                        margin: { top: 45, left: 10, right: 10 },
                    });
                } else {
                    console.error('autoTable not available');
                    showMessage('PDF table plugin not loaded properly.', 'error');
                    return;
                }
                
                console.log('Saving PDF...');
                doc.save('csv_data.pdf');
                showMessage('PDF downloaded successfully!', 'success');
                
            } catch (error) {
                console.error('PDF Error:', error);
                showMessage('PDF export failed: ' + error.message, 'error');
            }
        }
        
        function showMessage(message, type) {
            const messageDiv = document.getElementById('message');
            messageDiv.className = type;
            messageDiv.textContent = message;
        }
    </script>
</body>
</html>